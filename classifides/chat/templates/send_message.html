{% extends "base.html" %}

{% load static %}

{% block content %}
<div class="container">
    <h2>Messages with {{ recipient.username }}</h2>

    <div id="message-list">
        {% for message in messages %}
            <div class="message {% if message.sender == user %}sent{% else %}received{% endif %}">
                <strong>{{ message.sender.username }}:</strong> {{ message.content }}
            </div>
        {% empty %}
            <p>No messages yet. Start the conversation!</p>
        {% endfor %}
    </div>

    <div id="new-message" class="message-input-container">
        <textarea id="message-content" placeholder="Type your message here..." class="form-control" rows="4"></textarea>
        <button id="send-message" class="btn btn-primary mt-2">Send</button>
    </div>
</div>

<script>
    document.getElementById('send-message').addEventListener('click', function() {
        const content = document.getElementById('message-content').value.trim();

        if (content) {
            fetch("{% url 'send_message' ad.id recipient.id %}", {
                method: "POST",
                headers: {
                    "X-CSRFToken": "{{ csrf_token }}",
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ "content": content })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const messageList = document.getElementById('message-list');
                    const newMessage = document.createElement('div');
                    newMessage.classList.add('message');
                    newMessage.classList.add('sent');  // Assume the message is sent by the current user
                    newMessage.innerHTML = `<strong>{{ user.username }}:</strong> ${data.content}`;
                    messageList.appendChild(newMessage);

                    document.getElementById('message-content').value = "";
                    messageList.scrollTop = messageList.scrollHeight;  // Scroll to the bottom
                }
            })
            .catch(error => console.error('Error:', error));
        }
    });
</script>
{% endblock %}
