{% extends 'base.html' %}

{% load static %}
{% block title %}Chat with {{ ad.user.username }}{% endblock %}

{% block content %}
<div class="container my-4">
    <h1>Chat with {{ ad.user.username }}</h1>

    <div class="chat-messages" id="message-list">
        {% for message in messages %}
            <div class="message {% if message.sender == user %}sent{% else %}received{% endif %}" id="message-{{ message.id }}">
                <strong>{{ message.sender.username }}:</strong>
                <p>{{ message.content }}</p>
                <small class="text-muted">{{ message.timestamp }}</small>
            </div>
        {% empty %}
            <p>No messages yet.</p>
        {% endfor %}
    </div>

    <form id="message-form" method="post" class="mt-4">
        {% csrf_token %}
        <div class="form-group">
            <textarea id="message-input" name="content" class="form-control" rows="3" placeholder="Type your message here..."></textarea>
        </div>
        <button type="submit" class="btn btn-primary">Send</button>
    </form>
</div>

<script>
    const adId = "{{ ad.id }}"; 
    const chatSocket = new WebSocket(
        `ws://$127.0.0.1:8001/ws/chat/${adId}/`
    );

    chatSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        document.querySelector('#message-list').innerHTML += (
            `<div class="message">
                <strong>${data.sender}:</strong>
                <p>${data.message}</p>
            </div>`
        );
    };

    chatSocket.onclose = function(e) {
        console.error('Chat socket closed unexpectedly');
    };

    document.querySelector('#message-form').onsubmit = function(e) {
        e.preventDefault();
        const messageInputDom = document.querySelector('#message-input');
        const message = messageInputDom.value;
        chatSocket.send(JSON.stringify({
            'message': message
        }));
        messageInputDom.value = '';
    };
</script>

{% endblock %}
